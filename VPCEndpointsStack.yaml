AWSTemplateFormatVersion: 2010-09-09
Description: CFT creating VPC Endpoints
Mappings:
  RegionMap:
    us-east-1:
      s3endpoint: pl-63a5400a
    us-east-2:
      s3endpoint: pl-7ba54012
    us-west-1:
      s3endpoint: pl-6ba54002
    us-west-2:
      s3endpoint: pl-68a54001
Parameters:
  ProjectName:
    Description: ProjectName For the Reasources in the VPC
    Type: String
  VPCId:
    Description: CIDR block for the VPC
    Type: String
  Subnet2Id:
    Description: CIDR for the Subnet-2
    Type: String
  RouteTableId:
    Description: Route Table Id
    Type: String
  SecurityGroup1Id:
    Description: Security group-1 Id (ResourceSG)
    Type: String
  SecurityGroup2Id:
    Description: Security group-2 Id (ENISG)
    Type: String
Resources:
  ECREndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      SecurityGroupIds:
        - !Ref SecurityGroup2Id
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .ecr.api
      SubnetIds:
        - !Ref Subnet2Id
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
  CWEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      SecurityGroupIds:
        - !Ref SecurityGroup2Id
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .logs
      SubnetIds:
        - !Ref Subnet2Id
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
  STSEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      SecurityGroupIds:
        - !Ref SecurityGroup2Id
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .sts
      SubnetIds:
        - !Ref Subnet2Id
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
  SageMakerRunTimeEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      SecurityGroupIds:
        - !Ref SecurityGroup2Id
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .sagemaker.runtime
      SubnetIds:
        - !Ref Subnet2Id
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
  SageMakerAPIEndpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      SecurityGroupIds:
        - !Ref SecurityGroup2Id
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .sagemaker.api
      SubnetIds:
        - !Ref Subnet2Id
      VpcEndpointType: Interface
      VpcId: !Ref VPCId
  S3Endpoint:
    Type: 'AWS::EC2::VPCEndpoint'
    Properties:
      RouteTableIds:
        - !Ref RouteTableId
      ServiceName: !Join 
        - ''
        - - com.amazonaws.
          - !Ref 'AWS::Region'
          - .s3
      VpcEndpointType: Gateway
      VpcId: !Ref VPCId
  S3OutboundRule:
    Type: 'AWS::EC2::SecurityGroupEgress'
    DependsOn: S3Endpoint
    Properties:
      DestinationPrefixListId: !FindInMap 
        - RegionMap
        - !Ref 'AWS::Region'
        - s3endpoint
      Description: HTTPS traffic for S3
      FromPort: 443
      IpProtocol: tcp
      ToPort: 443
      GroupId: !Ref SecurityGroup1Id
Outputs:
  ECREndpoint:
    Description: ECR Endpoint
    Value: !Ref ECREndpoint
  CWEndpoint:
    Description: Cloud Watch Endpoint
    Value: !Ref CWEndpoint
  STSEndpoint:
    Description: STS Endpoint
    Value: !Ref STSEndpoint
  SageMakerRunTimeEndpoint:
    Description: SageMaker Run Time Endpoint
    Value: !Ref SageMakerRunTimeEndpoint
  SageMakerAPIEndpoint:
    Description: SageMaker API Endpoint
    Value: !Ref SageMakerAPIEndpoint
  S3Endpoint:
    Description: S3 Endpoint
    Value: !Ref S3Endpoint
