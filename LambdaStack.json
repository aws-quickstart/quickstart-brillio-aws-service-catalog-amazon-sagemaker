{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "SageMaker Lambda Function Setup",
    "Parameters": {
		"ProjectName": {
			"Description": "SageMaker Project name",
			"Type": "String"
		},
		"SourceBucket": {
		  "Description": "S3 Bucket Name where All cloudformation templates are stored.",
		  "Type": "String"
		}
    },
    "Resources": {
        "LambdaFunctionRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Statement": [{
						"Effect": "Allow",
						"Principal": {
							"Service": [
								"lambda.amazonaws.com"
							]
						},
						"Action": [
							"sts:AssumeRole"
						]
					}]
				},
				"ManagedPolicyArns" : [
					"arn:aws:iam::aws:policy/AmazonSageMakerFullAccess"
				],
				"Path": "/",
				"RoleName" : {
                    "Fn::Join": [
                        "",
                        [{
                                "Ref": "ProjectName"
                            },
                            "_SagemakerBuildRoles"
                        ]
                    ]
				},
				"Policies": [{
					"PolicyName": {
						"Fn::Join": [
							"",
							[{
									"Ref": "ProjectName"
								},
								"_SagemakerBuildPolicy"
							]
						]
					},
					"PolicyDocument": {
						"Version": "2012-10-17",
						"Statement": [
							{
								"Sid": "SagemakerBuildAction",
								"Effect": "Allow",
								"Action": [
									"iam:*",
									"kms:CreateGrant"
								],
								"Resource": "*"
							},
							{
								"Sid": "SagemakerBucketCleanUp",
								"Effect": "Allow",
								"Action": [
									"s3:*"
								],
								"Resource": [
									"arn:aws:s3:::*sagemaker*",
									"arn:aws:s3:::*sagemaker*/*"
								]
							},
							{
								"Sid": "LammbdaBasicExecution",
								"Effect": "Allow",
								"Action": [
									"logs:CreateLogGroup",
									"logs:CreateLogStream",
									"logs:PutLogEvents"
								],
								"Resource": [
									{"Fn::Join": ["", ["arn:aws:logs:", { "Ref" : "AWS::Region" }, ":", { "Ref" : "AWS::AccountId" }, ":log-group:/aws/lambda/*"]]}
								]
							}
						]
					}
				}]
			}
		},
        "PythonLayer": {
            "Type": "AWS::Lambda::LayerVersion",
            "Properties": {
                "CompatibleRuntimes": [
                    "python3.6",
                    "python2.7"
                ],
                "Content": {
                    "S3Bucket": { "Ref" : "SourceBucket" },
                    "S3Key": "PythonModule.zip"
                },
                "Description": "Python layer",
                "LayerName": {
					"Fn::Join": [
                        "",
                        [{
                                "Ref": "ProjectName"
                            },
                            "_LayerName"
                        ]
                    ]
                }

            }
        },
        "SageMakerFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "Code": {
                    "S3Bucket": { "Ref" : "SourceBucket" },
                    "S3Key": "SageMakerBuild.zip"
                },
                "Description": "Sage Maker lambda function",
                "FunctionName": {
					"Fn::Join": [
                        "",
                        [{
                                "Ref": "ProjectName"
                            },
                            "_SageMakerBuild"
                        ]
                    ]
				},
                "Handler": "lambda_function.lambda_handler",
                "Layers": [{
                    "Ref": "PythonLayer"
                }],
                "MemorySize": 128,
                "Role": {
					"Fn::GetAtt": ["LambdaFunctionRole", "Arn"]
				},
                "Runtime": "python3.6",
                "Tags": [{
                    "Key": "ProjectName",
                    "Value": { "Ref" : "ProjectName" }
                }],
                "Timeout": 840
            }
        }
    },
    "Outputs": {
		"PythonLayer": {
            "Value": {
                "Ref": "PythonLayer"
            },
            "Description": "Lambda layer ARN"
        },
        "LambdaFunction": {
            "Value": {
                "Fn::GetAtt": ["SageMakerFunction", "Arn"]
            },
            "Description": "Lambda function ARN"

        } 
    }
}